<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e5e7eb;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 2rem; color: #4ade80; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: rgba(22, 33, 62, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .card-label { font-size: 0.85rem; color: #9ca3af; margin-bottom: 8px; }
        .card-value { font-size: 2.5rem; font-weight: bold; }
        .card-value.blue { color: #60a5fa; }
        .card-value.green { color: #4ade80; }
        .card-value.purple { color: #a78bfa; }
        .card-context, .card-trend { font-size: 0.85rem; color: #9ca3af; margin-top: 8px; }
        .section {
            background: rgba(22, 33, 62, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .section-title { font-size: 1.25rem; margin-bottom: 16px; color: #e5e7eb; }
        .task-item {
            background: rgba(31, 41, 55, 0.6);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid #60a5fa;
        }
        .task-name { font-weight: 600; margin-bottom: 4px; }
        .task-time { font-size: 0.85rem; color: #9ca3af; }
        .task-source { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; }
        .task-source.notion { background: #ef4444; }
        .task-source.manual { background: #3b82f6; }
        .task-source.tracker { background: #10b981; }
        .progress-item { margin-bottom: 16px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .progress-bar { height: 8px; background: rgba(55, 65, 81, 0.5); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .chart-container { display: flex; align-items: flex-end; height: 150px; gap: 10px; padding: 20px 0; position: relative; }
        .chart-bar { flex: 1; border-radius: 4px; position: relative; transition: height 0.5s; min-height: 5px; }
        .avg-line { position: absolute; border-top: 2px dashed #6b7280; width: 100%; z-index: 10; pointer-events: none; }
        .avg-label { position: absolute; right: 0; font-size: 0.75rem; color: #6b7280; transform: translateY(-100%); }
        .chart-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8rem; color: #9ca3af; }
        .loading { text-align: center; color: #9ca3af; padding: 40px; }
        .error { color: #ef4444; padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; }
        .footer { text-align: center; color: #6b7280; font-size: 0.85rem; margin-top: 40px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; background: #4ade80; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ¤– ìë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œ</h1>
            </div>
            <div style="text-align: right;">
                <p style="color: #4ade80; font-weight: 600;"><span class="status-indicator"></span>ì˜¨ë¼ì¸</p>
                <p style="font-size: 0.85rem; color: #9ca3af;">KST (UTC+9)</p>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-label">ì˜¤ëŠ˜ì˜ ì‘ì—…</div>
                <div class="card-value blue" id="task-count">-</div>
                <div class="card-trend" id="task-trend">-</div>
            </div>
            <div class="card">
                <div class="card-label">ì´ ì‘ì—… ì‹œê°„</div>
                <div class="card-value green" id="total-time">-</div>
                <div class="card-context" id="time-context">-</div>
            </div>
            <div class="card">
                <div class="card-label">ì‹œìŠ¤í…œ ìƒíƒœ</div>
                <div class="card-value purple">ì •ìƒ</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“‹ ì‘ì—… ëª©ë¡</h2>
            <div id="task-list"><div class="loading">ë¡œë”© ì¤‘...</div></div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ¯ ëª©í‘œ ì§„í–‰ë¥ </h2>
            <div id="goal-list"><div class="loading">ë¡œë”© ì¤‘...</div></div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“ˆ ì£¼ê°„ ì‘ì—… ì‹œê°„</h2>
            <div class="chart-container" id="weekly-chart"><div class="loading">ë¡œë”© ì¤‘...</div></div>
            <div class="chart-labels">
                <span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span><span>ì¼</span>
            </div>
        </div>

        <div class="footer">
            <p>ğŸ“Š ë…¸ì…˜ + ìë™ ì—°ë™ | ğŸ¤– ìë¹„ìŠ¤ (Jarvis)</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://158.247.193.74:8081/api';
        const DAILY_GOAL_MINUTES = 180;
        const DAILY_GOAL_TASKS = 8;

        // ìƒ˜í”Œ ë°ì´í„° (API ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
        const SAMPLE_DATA = {
            summary: { task_count: 5, total_minutes: 315 },
            tasks: [
                { name: 'ëŒ€ì‹œë³´ë“œ ê°œë°œ', start_time: '2026-02-03T09:00:00', end_time: '2026-02-03T10:30:00', duration_seconds: 5400, result: 'ì™„ë£Œ', source: 'notion' },
                { name: 'ë…¸ì…˜ ì •ë¦¬', start_time: '2026-02-03T10:45:00', end_time: '2026-02-03T11:30:00', duration_seconds: 2700, result: 'ì§„í–‰ ì¤‘', source: 'notion' },
                { name: 'íˆ¬ì ê³µë¶€', start_time: '2026-02-03T14:00:00', end_time: '2026-02-03T15:30:00', duration_seconds: 5400, result: 'ì™„ë£Œ', source: 'tracker' },
                { name: 'ê¸€ì“°ê¸°', start_time: '2026-02-03T16:00:00', end_time: '2026-02-03T17:00:00', duration_seconds: 3600, result: 'ì™„ë£Œ', source: 'manual' },
                { name: 'ëŸ¬ë‹', start_time: '2026-02-03T18:30:00', end_time: '2026-02-03T19:00:00', duration_seconds: 1800, result: 'ì™„ë£Œ', source: 'tracker' }
            ],
            goals: [
                { name: 'íˆ¬ì ìˆ˜ìµë¥ ', current_value: 40, target_value: 100, unit: '%' },
                { name: 'ì„œì  100ê¶Œ', current_value: 30, target_value: 100, unit: 'ê¶Œ' },
                { name: 'ìë™í™” ì‹œìŠ¤í…œ', current_value: 85, target_value: 100, unit: '%' },
                { name: 'ìš´ë™ 150ë¶„/ì£¼', current_value: 90, target_value: 150, unit: 'ë¶„' }
            ],
            weekly: [
                { date: '2026-01-29', minutes: 120 },
                { date: '2026-01-30', minutes: 180 },
                { date: '2026-01-31', minutes: 240 },
                { date: '2026-02-01', minutes: 150 },
                { date: '2026-02-02', minutes: 300 },
                { date: '2026-02-03', minutes: 315 },
                { date: '2026-02-04', minutes: 0 }
            ]
        };

        async function loadDashboard() {
            try {
                const summaryRes = await fetch(`${API_BASE}/dashboard`);
                if (!summaryRes.ok) throw new Error('API ì—°ê²° ì‹¤íŒ¨');
                const summaryData = await summaryRes.json();

                const todayTaskCount = summaryData.summary.task_count;
                const todayMinutes = summaryData.summary.total_minutes;

                document.getElementById('task-count').textContent = todayTaskCount + 'ê±´';
                document.getElementById('total-time').textContent = todayMinutes + 'ë¶„';

                renderTimeContext(todayMinutes, DAILY_GOAL_MINUTES);
                renderTaskTrend(todayTaskCount);

                const tasksRes = await fetch(`${API_BASE}/tasks`);
                const tasksData = await tasksRes.json();
                renderTasks(tasksData.tasks || SAMPLE_DATA.tasks);

                const goalsRes = await fetch(`${API_BASE}/goals`);
                const goalsData = await goalsRes.json();
                renderGoals(goalsData.goals || SAMPLE_DATA.goals);

                const weeklyRes = await fetch(`${API_BASE}/weekly`);
                const weeklyData = await weeklyRes.json();
                renderWeekly(weeklyData.weekly || SAMPLE_DATA.weekly);

            } catch (error) {
                console.log('ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©');
                document.getElementById('task-count').textContent = SAMPLE_DATA.summary.task_count + 'ê±´';
                document.getElementById('total-time').textContent = SAMPLE_DATA.summary.total_minutes + 'ë¶„';
                renderTasks(SAMPLE_DATA.tasks);
                renderGoals(SAMPLE_DATA.goals);
                renderWeekly(SAMPLE_DATA.weekly);
                renderTimeContext(SAMPLE_DATA.summary.total_minutes, DAILY_GOAL_MINUTES);
                renderTaskTrend(SAMPLE_DATA.summary.task_count);
            }
        }

        function renderTaskTrend(todayCount) {
            const trendEl = document.getElementById('task-trend');
            const diff = todayCount - 3;
            if (diff > 0) {
                trendEl.innerHTML = `<span style="color: #4ade80;">â–² ì–´ì œë³´ë‹¤ ${diff}ê±´</span>`;
            } else if (diff < 0) {
                trendEl.innerHTML = `<span style="color: #f87171;">â–¼ ì–´ì œë³´ë‹¤ ${Math.abs(diff)}ê±´</span>`;
            } else {
                trendEl.innerHTML = `<span style="color: #9ca3af;">- ì–´ì œì™€ ê°™ìŒ</span>`;
            }
        }

        function renderTimeContext(todayMinutes, goalMinutes) {
            const contextEl = document.getElementById('time-context');
            const percentage = Math.min(Math.round((todayMinutes / goalMinutes) * 100), 100);
            const remaining = Math.max(goalMinutes - todayMinutes, 0);
            if (todayMinutes >= goalMinutes) {
                contextEl.innerHTML = `<span style="color: #4ade80;">âœ“ ëª©í‘œ ë‹¬ì„±!</span>`;
            } else {
                contextEl.textContent = `ëª©í‘œ ${goalMinutes}ë¶„ ì¤‘ ${percentage}% | ë‚¨ì€ ${remaining}ë¶„`;
            }
        }

        function renderTasks(tasks) {
            const container = document.getElementById('task-list');
            if (tasks.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center;">ì˜¤ëŠ˜ì˜ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            container.innerHTML = tasks.map(task => {
                const startTime = new Date(task.start_time);
                const endTime = new Date(task.end_time);
                const timeStr = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
                const duration = Math.floor(task.duration_seconds / 60);
                const sourceLabel = task.source === 'notion' ? 'ë…¸ì…˜' : (task.source === 'tracker' ? 'ì¶”ì ' : 'ìˆ˜ë™');
                return `
                    <div class="task-item">
                        <div class="task-name">${task.name}<span class="task-source ${task.source}">${sourceLabel}</span></div>
                        <div class="task-time">${timeStr} (${duration}ë¶„) ${task.result || ''}</div>
                    </div>
                `;
            }).join('');
        }

        function renderGoals(goals) {
            const container = document.getElementById('goal-list');
            container.innerHTML = goals.map(goal => {
                const percentage = Math.min((goal.current_value / goal.target_value) * 100, 100);
                let color, status;
                if (percentage >= 100) { color = '#4ade80'; status = 'ğŸ‰'; }
                else if (percentage >= 80) { color = '#60a5fa'; status = 'ğŸ‘'; }
                else if (percentage >= 50) { color = '#fbbf24'; status = 'âš ï¸'; }
                else { color = '#f87171'; status = 'ğŸš¨'; }
                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span>${status} ${goal.name}</span>
                            <span style="color: ${color};">${goal.current_value}${goal.unit || ''} / ${goal.target_value}${goal.unit || ''}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%; background: ${color};"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderWeekly(weekly) {
            const container = document.getElementById('weekly-chart');
            const maxMinutes = Math.max(...weekly.map(d => d.minutes), 1);
            const avgMinutes = weekly.reduce((a, b) => a + b.minutes, 0) / 7;
            const avgTopPercent = 100 - (avgMinutes / maxMinutes * 100);
            let html = `<div class="avg-line" style="top: ${avgTopPercent}%;"></div>`;
            html += `<div class="avg-label" style="top: ${avgTopPercent}%; margin-top: -2px;">í‰ê·  ${Math.round(avgMinutes)}ë¶„</div>`;
            const maxVal = Math.max(...weekly.map(d => d.minutes));
            const colors = ['#3b82f6', '#60a5fa', '#3b82f6', '#60a5fa', '#3b82f6', '#4ade80', '#1f2937'];
            html += weekly.map((day, i) => {
                const height = (day.minutes / maxMinutes) * 100;
                const isMax = day.minutes === maxVal;
                const bg = isMax ? '#4ade80' : colors[i % colors.length];
                return `<div class="chart-bar" style="height: ${Math.max(height, 5)}%; background: ${bg};" title="${day.date}: ${day.minutes}ë¶„"></div>`;
            }).join('');
            container.innerHTML = html;
        }

        loadDashboard();
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
