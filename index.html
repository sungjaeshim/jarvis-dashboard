<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e5e7eb;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 2rem; color: #4ade80; }
        .subtitle { color: #9ca3af; font-size: 0.9rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card {
            background: rgba(22, 33, 62, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .card-label { font-size: 0.85rem; color: #9ca3af; margin-bottom: 8px; }
        .card-value { font-size: 2.5rem; font-weight: bold; }
        .card-value.blue { color: #60a5fa; }
        .card-value.green { color: #4ade80; }
        .card-value.purple { color: #a78bfa; }
        .card-context, .card-trend { font-size: 0.85rem; color: #9ca3af; margin-top: 8px; }
        .section {
            background: rgba(22, 33, 62, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .section-title { font-size: 1.25rem; margin-bottom: 16px; color: #e5e7eb; }
        .task-item {
            background: rgba(31, 41, 55, 0.6);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 3px solid #60a5fa;
        }
        .task-name { font-weight: 600; margin-bottom: 4px; }
        .task-time { font-size: 0.85rem; color: #9ca3af; }
        .task-source {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
        }
        .task-source.notion { background: #ef4444; }
        .task-source.manual { background: #3b82f6; }
        .progress-item { margin-bottom: 16px; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .progress-bar {
            height: 8px;
            background: rgba(55, 65, 81, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 4px;
            transition: width 0.5s;
        }
        .footer { text-align: center; color: #6b7280; font-size: 0.85rem; margin-top: 40px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; background: #4ade80; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .chart-container { display: flex; align-items: flex-end; height: 150px; gap: 10px; padding: 20px 0; position: relative; }
        .chart-bar { flex: 1; background: linear-gradient(to top, #3b82f6, #60a5fa); border-radius: 4px; position: relative; transition: height 0.5s, background 0.3s; min-height: 5px; }
        .chart-bar.max-value { background: #4ade80; box-shadow: 0 0 10px rgba(74, 222, 128, 0.3); }
        .chart-bar.min-value { opacity: 0.6; }
        .avg-line { position: absolute; border-top: 2px dashed #6b7280; width: 100%; z-index: 10; pointer-events: none; }
        .avg-label { position: absolute; right: 0; font-size: 0.75rem; color: #6b7280; transform: translateY(-100%); }
        .chart-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8rem; color: #9ca3af; }
        .loading { text-align: center; color: #9ca3af; padding: 40px; }
        .error { color: #ef4444; padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ¤– ìë¹„ìŠ¤ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="subtitle" id="update-time">ë¡œë”© ì¤‘...</p>
            </div>
            <div style="text-align: right;">
                <p style="color: #4ade80; font-weight: 600;"><span class="status-indicator"></span>ì˜¨ë¼ì¸</p>
                <p style="font-size: 0.85rem; color: #9ca3af;">KST (UTC+9)</p>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-label">ì˜¤ëŠ˜ì˜ ì‘ì—…</div>
                <div class="card-value blue" id="task-count">-</div>
                <div class="card-trend" id="task-trend">-</div>
            </div>
            <div class="card">
                <div class="card-label">ì´ ì‘ì—… ì‹œê°„</div>
                <div class="card-value green" id="total-time">-</div>
                <div class="card-context" id="time-context">-</div>
            </div>
            <div class="card">
                <div class="card-label">ì‹œìŠ¤í…œ ìƒíƒœ</div>
                <div class="card-value purple">ì •ìƒ</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“‹ ì‘ì—… ëª©ë¡</h2>
            <div id="task-list">
                <div class="loading">ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ¯ ëª©í‘œ ì§„í–‰ë¥ </h2>
            <div id="goal-list">
                <div class="loading">ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ğŸ“ˆ ì£¼ê°„ ì‘ì—… ì‹œê°„</h2>
            <div class="chart-container" id="weekly-chart">
                <div class="loading">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="chart-labels">
                <span>ì›”</span><span>í™”</span><span>ìˆ˜</span><span>ëª©</span><span>ê¸ˆ</span><span>í† </span><span>ì¼</span>
            </div>
        </div>

        <div class="footer">
            <p>ğŸ”„ 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  | ğŸ“Š ë…¸ì…˜ + ìë™ ì—°ë™ | ğŸ¤– ìë¹„ìŠ¤ (Jarvis)</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://158.247.193.74:8081/api';
        const DAILY_GOAL_MINUTES = 180;
        const DAILY_GOAL_TASKS = 8;

        async function loadDashboard() {
            try {
                // ì˜¤ëŠ˜ ìš”ì•½ ë°ì´í„°
                const summaryRes = await fetch(`${API_BASE}/dashboard`);
                const summaryData = await summaryRes.json();

                const todayTaskCount = summaryData.summary.task_count;
                const todayMinutes = summaryData.summary.total_minutes;

                document.getElementById('task-count').textContent = todayTaskCount + 'ê±´';
                document.getElementById('total-time').textContent = todayMinutes + 'ë¶„';

                // ì–´ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const yesterdayRes = await fetch(`${API_BASE}/dashboard/yesterday`);
                let yesterdayData = null;
                if (yesterdayRes.ok) {
                    yesterdayData = await yesterdayRes.json();
                }

                // ì‘ì—… íŠ¸ë Œë“œ í‘œì‹œ
                renderTaskTrend(todayTaskCount, yesterdayData);

                // ì‹œê°„ ì»¨í…ìŠ¤íŠ¸ í‘œì‹œ
                renderTimeContext(todayMinutes, DAILY_GOAL_MINUTES);

                // ì‘ì—… ëª©ë¡
                const tasksRes = await fetch(`${API_BASE}/tasks`);
                const tasksData = await tasksRes.json();
                renderTasks(tasksData.tasks);

                // ëª©í‘œ
                const goalsRes = await fetch(`${API_BASE}/goals`);
                const goalsData = await goalsRes.json();
                renderGoals(goalsData.goals);

                // ì£¼ê°„ ë°ì´í„°
                const weeklyRes = await fetch(`${API_BASE}/weekly`);
                const weeklyData = await weeklyRes.json();
                renderWeekly(weeklyData.weekly);

                // ì‹œê°„ ì—…ë°ì´íŠ¸
                updateTime();

            } catch (error) {
                console.error('ë¡œë”© ì˜¤ë¥˜:', error);
                document.getElementById('task-list').innerHTML = '<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
                document.getElementById('task-trend').textContent = 'ì •ë³´ ì—†ìŒ';
                document.getElementById('time-context').textContent = 'ì •ë³´ ì—†ìŒ';
            }
        }

        function renderTaskTrend(todayCount, yesterdayData) {
            const trendEl = document.getElementById('task-trend');

            if (!yesterdayData || !yesterdayData.summary) {
                trendEl.textContent = '-';
                return;
            }

            const yesterdayCount = yesterdayData.summary.task_count || 0;
            const diff = todayCount - yesterdayCount;

            if (diff > 0) {
                trendEl.innerHTML = `<span style="color: #4ade80;">â–² ì–´ì œë³´ë‹¤ ${diff}ê±´</span>`;
            } else if (diff < 0) {
                trendEl.innerHTML = `<span style="color: #f87171;">â–¼ ì–´ì œë³´ë‹¤ ${Math.abs(diff)}ê±´</span>`;
            } else {
                trendEl.innerHTML = `<span style="color: #9ca3af;">- ì–´ì œì™€ ê°™ìŒ</span>`;
            }
        }

        function renderTimeContext(todayMinutes, goalMinutes) {
            const contextEl = document.getElementById('time-context');

            if (todayMinutes === null || todayMinutes === undefined) {
                contextEl.textContent = 'ì •ë³´ ì—†ìŒ';
                return;
            }

            const percentage = Math.min(Math.round((todayMinutes / goalMinutes) * 100), 100);
            const remaining = Math.max(goalMinutes - todayMinutes, 0);

            if (todayMinutes >= goalMinutes) {
                contextEl.innerHTML = `<span style="color: #4ade80;">âœ“ ëª©í‘œ ë‹¬ì„±!</span>`;
            } else {
                contextEl.textContent = `ëª©í‘œ ${goalMinutes}ë¶„ ì¤‘ ${percentage}% | ë‚¨ì€ ${remaining}ë¶„`;
            }
        }

        function renderTasks(tasks) {
            const container = document.getElementById('task-list');

            if (tasks.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center;">ì˜¤ëŠ˜ì˜ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const startTime = new Date(task.start_time);
                const endTime = new Date(task.end_time);
                const timeStr = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
                const duration = Math.floor(task.duration_seconds / 60);

                return `
                    <div class="task-item">
                        <div class="task-name">${task.name}
                            <span class="task-source ${task.source}">${task.source === 'notion' ? 'ë…¸ì…˜' : 'ìˆ˜ë™'}</span>
                        </div>
                        <div class="task-time">${timeStr} (${duration}ë¶„) ${task.result || ''}</div>
                    </div>
                `;
            }).join('');
        }

        function renderGoals(goals) {
            const container = document.getElementById('goal-list');

            container.innerHTML = goals.map(goal => {
                const percentage = Math.min((goal.current_value / goal.target_value) * 100, 100);

                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span>${goal.name}</span>
                            <span style="color: #60a5fa;">${goal.current_value}${goal.unit || ''} / ${goal.target_value}${goal.unit || ''}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderWeekly(weekly) {
            const container = document.getElementById('weekly-chart');
            const maxMinutes = Math.max(...weekly.map(d => d.minutes), 1);
            const avgMinutes = weekly.reduce((a, b) => a + b.minutes, 0) / 7;

            // í‰ê· ì„  ìœ„ì¹˜ ê³„ì‚°
            const avgTopPercent = 100 - (avgMinutes / maxMinutes * 100);

            // í‰ê· ì„  HTML
            let html = `<div class="avg-line" style="top: ${avgTopPercent}%;"></div>`;
            html += `<div class="avg-label" style="top: ${avgTopPercent}%; margin-top: -2px;">í‰ê·  ${Math.round(avgMinutes)}ë¶„</div>`;

            // ì°¨íŠ¸ ë°” (ìµœëŒ€ê°’ ì´ˆë¡ìƒ‰, ìµœì†Œê°’ íšŒìƒ‰)
            const maxVal = Math.max(...weekly.map(d => d.minutes));
            const minVal = Math.min(...weekly.map(d => d.minutes));

            html += weekly.map(day => {
                const height = (day.minutes / maxMinutes) * 100;
                const isMax = day.minutes === maxVal;
                const isMin = day.minutes === minVal && day.minutes > 0;
                const extraClass = isMax ? 'max-value' : (isMin ? 'min-value' : '');
                const dayName = new Date(day.date).toLocaleDateString('ko-KR', { weekday: 'short' });
                return `<div class="chart-bar ${extraClass}" style="height: ${Math.max(height, 5)}%;" title="${day.date}: ${day.minutes}ë¶„"></div>`;
            }).join('');

            container.innerHTML = html;
        }

        function updateTime() {
            const now = new Date();
            const kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
            const timeStr = kstTime.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('update-time').textContent = 'ë§ˆì§€ë§‰ ê°±ì‹ : ' + timeStr;
        }

        // ì´ˆê¸° ë¡œë”©
        loadDashboard();

        // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
      // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
